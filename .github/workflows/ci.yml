name: Android CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

# Needed for creating/pushing tags + creating releases
permissions:
  contents: write

env:
  TOMTOM_API_KEY: ${{ secrets.TOMTOM_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  OpenRouteService_API_KEY: ${{ secrets.OpenRouteService_API_KEY }}
  MAILERSEND_API_KEY: ${{ secrets.MAILERSEND_API_KEY }}
  GOOGLE_APP_PASS: ${{ secrets.GOOGLE_APP_PASS }}

  # ThingsBoard secrets (add these in repo Settings → Secrets and variables → Actions)
  TB_HOST: ${{ secrets.TB_HOST }}
  TB_USER: ${{ secrets.TB_USER }}
  TB_PASS: ${{ secrets.TB_PASS }}
  TARGET_DEVICE_ID: ${{ secrets.TARGET_DEVICE_ID }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make gradlew executable (fix permission denied)
        run: |
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
          else
            echo "Warning: ./gradlew not found in repo root"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install utilities (jq, zip, unzip)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip unzip

      - name: Build APK (Release then Debug fallback)
        id: build_apk
        run: |
          set -euo pipefail
          if [ -f ./gradlew ] && [ ! -x ./gradlew ]; then
            chmod +x ./gradlew
          fi

          # Try to build release; if it fails, try debug
          if ./gradlew clean assembleRelease --stacktrace; then
            echo "assembleRelease succeeded"
          else
            echo "assembleRelease failed, trying assembleDebug"
            ./gradlew assembleDebug --stacktrace
          fi

          # 1) Check explicit app/release/app-release.apk (project-specific location)
          if [ -f "app/release/app-release.apk" ]; then
            APK_PATH="app/release/app-release.apk"
          else
            # 2) Check standard Android output directories (release, debug)
            APK_PATH=$(find . -type f -path "*/app/build/outputs/apk/release/*.apk" -print -quit || true)
            if [ -z "$APK_PATH" ]; then
              APK_PATH=$(find . -type f -path "*/app/build/outputs/apk/debug/*.apk" -print -quit || true)
            fi
            # 3) Last-resort: any app-release.apk anywhere in repo
            if [ -z "$APK_PATH" ]; then
              APK_PATH=$(find . -type f -name "app-release.apk" -print -quit || true)
            fi
          fi

          if [ -z "$APK_PATH" ]; then
            echo "ERROR: APK not found. Searched app/release, build outputs, and any app-release.apk."
            echo "Printing build outputs for debugging:"
            find app/build -maxdepth 6 -type f -print || true
            echo "Also listing repo files near expected path:"
            ls -la app || true
            exit 1
          fi

          echo "Found APK: $APK_PATH"
          echo "APK_PATH=$APK_PATH" >> "$GITHUB_ENV"
          SHORT_SHA=${GITHUB_SHA::7}
          TAG="release-${SHORT_SHA}"
          echo "TAG=$TAG" >> "$GITHUB_ENV"
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"

      # --- Release/Tag steps only on push to main ---
      - name: Create annotated git tag locally (for Release)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG}" -m "Automated release ${TAG}" || true
          git push origin "${TAG}" || true

      - name: Create GitHub Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.TAG }}
          release_name: ${{ env.TAG }}
          body: Automated release from CI for commit ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK as release asset
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: upload_asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.APK_PATH }}
          asset_name: app_${{ env.SHORT_SHA }}.apk
          asset_content_type: application/vnd.android.package-archive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release asset browser_download_url
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: get_asset_url
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          TAG="${{ env.TAG }}"
          API_URL="https://api.github.com/repos/${OWNER}/${REPO}/releases/tags/${TAG}"
          echo "Querying GitHub API: $API_URL"
          RELEASE_JSON=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "$API_URL")
          ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[0].browser_download_url')
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            echo "ERROR: Could not obtain asset URL. Response:"
            echo "$RELEASE_JSON"
            exit 1
          fi
          echo "ASSET_URL=$ASSET_URL" >> "$GITHUB_ENV"
          echo "ASSET_URL=$ASSET_URL"

      - name: Compute APK SHA256
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: compute_sha
        run: |
          set -euo pipefail
          SHASUM=$(sha256sum "${{ env.APK_PATH }}" | awk '{print $1}')
          echo "APK_SHA256=$SHASUM" >> "$GITHUB_ENV"
          echo "APK_SHA256=$SHASUM"

      - name: (Optional) Verify asset URL reachable
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          echo "Checking asset URL: ${ASSET_URL}"
          if ! curl --head --fail --location --max-time 20 "${ASSET_URL}"; then
            echo "WARNING: Asset URL not reachable from runner."
          fi

      - name: Login to ThingsBoard Cloud and get JWT
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: tb_login
        shell: bash
        run: |
          set -euo pipefail

          TBHOST="${TB_HOST:-https://thingsboard.cloud}"
          TBHOST="${TBHOST%/}"

          echo "Logging into ThingsBoard at ${TBHOST}"

          LOGIN_RESP="$(curl -sS -X POST "${TBHOST}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${TB_USER}\",\"password\":\"${TB_PASS}\"}")"

          TB_TOKEN="$(echo "${LOGIN_RESP}" | jq -r '.token // .accessToken // empty')"

          if [[ -z "${TB_TOKEN}" ]]; then
            echo "ERROR: ThingsBoard login failed. Response:"
            echo "${LOGIN_RESP}"
            exit 1
          fi

          echo "TB_TOKEN=${TB_TOKEN}" >> "${GITHUB_ENV}"
          echo "Logged into ThingsBoard."

      - name: Publish APK metadata to ThingsBoard (Server attribute latest_apk)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: publish_tb
        shell: bash
        run: |
          set -euo pipefail

          TBHOST="${TB_HOST:-https://thingsboard.cloud}"
          TBHOST="${TBHOST%/}"

          DEVICE_ID="${TARGET_DEVICE_ID:-}"
          if [[ -z "${DEVICE_ID}" || "${DEVICE_ID}" == "null" ]]; then
            echo "ERROR: TARGET_DEVICE_ID secret is missing."
            exit 1
          fi

          if [[ -z "${TB_TOKEN:-}" ]]; then
            echo "ERROR: TB_TOKEN is missing (tb_login did not run or failed)."
            exit 1
          fi

          ATTR_PAYLOAD="$(jq -n \
            --arg url "${ASSET_URL}" \
            --arg ver "${TAG}" \
            --arg sha "sha256:${APK_SHA256}" \
            --arg commit "${GITHUB_SHA}" \
            '{latest_apk: {url:$url, version:$ver, checksum:$sha, commit:$commit}}')"

          echo "Posting metadata to ThingsBoard for device ${DEVICE_ID}"
          RESPONSE="$(curl -sS -X POST "${TBHOST}/api/plugins/telemetry/DEVICE/${DEVICE_ID}/attributes/SERVER_SCOPE" \
            -H "Content-Type: application/json" \
            -H "X-Authorization: Bearer ${TB_TOKEN}" \
            -d "${ATTR_PAYLOAD}")"

          echo "ThingsBoard response: ${RESPONSE}"

      - name: Cleanup local tag (optional)
        if: always()
        run: |
          git tag -d "${{ env.TAG }}" || true

