name: Android CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  TOMTOM_API_KEY: ${{ secrets.TOMTOM_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  OpenRouteService_API_KEY: ${{ secrets.OpenRouteService_API_KEY }}
  MAILERSEND_API_KEY: ${{ secrets.MAILERSEND_API_KEY }}
  GOOGLE_APP_PASS: ${{ secrets.GOOGLE_APP_PASS }}

  TB_HOST: ${{ secrets.TB_HOST }}
  TB_USER: ${{ secrets.TB_USER }}
  TB_PASS: ${{ secrets.TB_PASS }}
  TARGET_DEVICE_ID: ${{ secrets.TARGET_DEVICE_ID }}

  # OTA package naming
  TB_OTA_TITLE: BusFlow-Android
  TB_OTA_TYPE: SOFTWARE

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install utilities (jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build APK (Release then Debug fallback)
        id: build_apk
        shell: bash
        run: |
          set -euo pipefail

          chmod +x ./gradlew

          ./gradlew clean assembleRelease --stacktrace || true
          ./gradlew assembleDebug --stacktrace

          APK_SOURCE_PATH="$(find . -type f -path "*/app/build/outputs/apk/release/*.apk" -print -quit || true)"
          if [ -z "$APK_SOURCE_PATH" ]; then
            APK_SOURCE_PATH="$(find . -type f -path "*/app/build/outputs/apk/debug/*.apk" -print -quit || true)"
          fi

          if [ -z "$APK_SOURCE_PATH" ]; then
            echo "ERROR: APK not found."
            find app/build -maxdepth 6 -type f -print || true
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="release-${SHORT_SHA}"

          # Copy to a predictable filename for release + OTA
          RELEASE_APK="app_${SHORT_SHA}.apk"
          cp "$APK_SOURCE_PATH" "$RELEASE_APK"

          APK_SHA256="$(sha256sum "$RELEASE_APK" | awk '{print $1}')"
          SHA_FILE="${RELEASE_APK}.sha256"
          echo "${APK_SHA256}  ${RELEASE_APK}" > "${SHA_FILE}"

          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"
          echo "TAG=$TAG" >> "$GITHUB_ENV"
          echo "APK_PATH=$RELEASE_APK" >> "$GITHUB_ENV"
          echo "APK_SHA256=$APK_SHA256" >> "$GITHUB_ENV"
          echo "SHA_FILE=$SHA_FILE" >> "$GITHUB_ENV"

          echo "Built: $RELEASE_APK"
          echo "sha256: $APK_SHA256"

      # Create/update a GitHub Release per commit on main
      - name: Create GitHub Release + upload APK assets
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          body: |
            Automated release from CI for commit ${{ github.sha }}
            sha256:${{ env.APK_SHA256 }}
          files: |
            ${{ env.APK_PATH }}
            ${{ env.SHA_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to ThingsBoard and get JWT
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: tb_login
        shell: bash
        run: |
          set -euo pipefail
          TBHOST="${TB_HOST:-https://thingsboard.cloud}"
          TBHOST="${TBHOST%/}"

          LOGIN_RESP="$(curl -sS -X POST "${TBHOST}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${TB_USER}\",\"password\":\"${TB_PASS}\"}")"

          TB_TOKEN="$(echo "${LOGIN_RESP}" | jq -r '.token // .accessToken // empty')"
          if [[ -z "${TB_TOKEN}" ]]; then
            echo "ERROR: ThingsBoard login failed:"
            echo "${LOGIN_RESP}"
            exit 1
          fi

          echo "TB_TOKEN=${TB_TOKEN}" >> "${GITHUB_ENV}"
          echo "Logged into ThingsBoard."

      - name: Upload APK into ThingsBoard OTA Updates (create package + upload binary)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          TBHOST="${TB_HOST:-https://thingsboard.cloud}"
          TBHOST="${TBHOST%/}"

          DEVICE_ID="${TARGET_DEVICE_ID:?TARGET_DEVICE_ID missing}"
          TITLE="${TB_OTA_TITLE:-BusFlow-Android}"
          TYPE="${TB_OTA_TYPE:-SOFTWARE}"
          VERSION="${TAG}"

          APK_PATH="${APK_PATH:?APK_PATH missing}"
          APK_SHA256="${APK_SHA256:?APK_SHA256 missing}"

          # 1) Get deviceProfileId from the target device
          DEVICE_JSON="$(curl -sS -H "X-Authorization: Bearer ${TB_TOKEN}" \
            "${TBHOST}/api/device/${DEVICE_ID}")"
          DEVICE_PROFILE_ID="$(echo "${DEVICE_JSON}" | jq -r '.deviceProfileId.id // empty')"
          if [[ -z "${DEVICE_PROFILE_ID}" ]]; then
            echo "ERROR: Could not read deviceProfileId:"
            echo "${DEVICE_JSON}"
            exit 1
          fi

          # 2) Create OTA package info (title+version+type+deviceProfileId)
          OTA_INFO="$(jq -n \
            --arg title "${TITLE}" \
            --arg version "${VERSION}" \
            --arg type "${TYPE}" \
            --arg dpId "${DEVICE_PROFILE_ID}" \
            '{title:$title, version:$version, type:$type,
              deviceProfileId:{entityType:"DEVICE_PROFILE", id:$dpId}}')"

          CREATE_RESP="$(curl -sS -w $'\n%{http_code}' -X POST "${TBHOST}/api/otaPackage" \
            -H "Content-Type: application/json" \
            -H "X-Authorization: Bearer ${TB_TOKEN}" \
            -d "${OTA_INFO}")"

          CREATE_JSON="$(echo "${CREATE_RESP}" | head -n -1)"
          CREATE_CODE="$(echo "${CREATE_RESP}" | tail -n 1)"

          OTA_ID=""
          if [[ "${CREATE_CODE}" == "200" || "${CREATE_CODE}" == "201" ]]; then
            OTA_ID="$(echo "${CREATE_JSON}" | jq -r '.id.id // empty')"
          else
            # If it already exists (rerun), search for it (your TB swagger UI shows exact params for your version)
            LIST_JSON="$(curl -sS -H "X-Authorization: Bearer ${TB_TOKEN}" \
              "${TBHOST}/api/otaPackages?pageSize=50&page=0&textSearch=${VERSION}")"
            OTA_ID="$(echo "${LIST_JSON}" | jq -r --arg t "${TITLE}" --arg v "${VERSION}" \
              '.data[] | select(.title==$t and .version==$v) | .id.id' | head -n 1)"
          fi

          if [[ -z "${OTA_ID}" ]]; then
            echo "ERROR: Could not determine OTA package id."
            echo "Create response:"
            echo "${CREATE_JSON}"
            exit 1
          fi

          # 3) Upload package data (binary) to OTA package
          # Endpoint form is documented in Swagger as: POST /api/otaPackage/{otaPackageId}{?checksum,checksumAlgorithm} :contentReference[oaicite:2]{index=2}
          curl -sS -X POST \
            "${TBHOST}/api/otaPackage/${OTA_ID}?checksumAlgorithm=SHA256&checksum=${APK_SHA256}" \
            -H "X-Authorization: Bearer ${TB_TOKEN}" \
            -F "file=@${APK_PATH};type=application/vnd.android.package-archive" \
            >/dev/null

          echo "âœ… Uploaded to ThingsBoard OTA Updates: title=${TITLE}, version=${VERSION}, id=${OTA_ID}"

