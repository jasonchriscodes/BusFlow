name: Android CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  TOMTOM_API_KEY: ${{ secrets.TOMTOM_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  OpenRouteService_API_KEY: ${{ secrets.OpenRouteService_API_KEY }}
  MAILERSEND_API_KEY: ${{ secrets.MAILERSEND_API_KEY }}
  GOOGLE_APP_PASS: ${{ secrets.GOOGLE_APP_PASS }}

  # ThingsBoard secrets (Settings → Secrets and variables → Actions)
  TB_HOST: ${{ secrets.TB_HOST }}
  TB_USER: ${{ secrets.TB_USER }}
  TB_PASS: ${{ secrets.TB_PASS }}
  TARGET_DEVICE_ID: ${{ secrets.TARGET_DEVICE_ID }}

  # OTA package naming
  TB_OTA_TITLE: BusFlow-Android
  TB_OTA_TYPE: SOFTWARE

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make gradlew executable (fix permission denied)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
          else
            echo "ERROR: ./gradlew not found in repo root"
            exit 1
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install utilities (jq)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build APK (Release then Debug fallback)
        id: build_apk
        shell: bash
        run: |
          set -euo pipefail

          # Try release first, then always build debug as fallback
          ./gradlew clean assembleRelease --stacktrace || true
          ./gradlew assembleDebug --stacktrace

          RELEASE_APK="$(find . -type f -path "*/app/build/outputs/apk/release/*.apk" -print -quit 2>/dev/null || true)"
          DEBUG_APK="$(find . -type f -path "*/app/build/outputs/apk/debug/*.apk" -print -quit 2>/dev/null || true)"

          if [[ -n "$RELEASE_APK" ]]; then
            APK_SOURCE_PATH="$RELEASE_APK"
            BUILD_VARIANT="release"
          elif [[ -n "$DEBUG_APK" ]]; then
            APK_SOURCE_PATH="$DEBUG_APK"
            BUILD_VARIANT="debug"
          else
            echo "ERROR: APK not found in release or debug outputs."
            find app/build -maxdepth 6 -type f -print || true
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="release-${SHORT_SHA}"

          RELEASE_APK_NAME="app_${SHORT_SHA}_${BUILD_VARIANT}.apk"
          cp "$APK_SOURCE_PATH" "$RELEASE_APK_NAME"

          APK_SHA256="$(sha256sum "$RELEASE_APK_NAME" | awk '{print $1}')"
          SHA_FILE="${RELEASE_APK_NAME}.sha256"
          echo "${APK_SHA256}  ${RELEASE_APK_NAME}" > "${SHA_FILE}"

          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"
          echo "TAG=$TAG" >> "$GITHUB_ENV"
          echo "BUILD_VARIANT=$BUILD_VARIANT" >> "$GITHUB_ENV"
          echo "APK_PATH=$RELEASE_APK_NAME" >> "$GITHUB_ENV"
          echo "APK_SHA256=$APK_SHA256" >> "$GITHUB_ENV"
          echo "SHA_FILE=$SHA_FILE" >> "$GITHUB_ENV"

          echo "Using APK: $APK_SOURCE_PATH"
          echo "Packaged as: $RELEASE_APK_NAME"
          echo "sha256: $APK_SHA256"

      # --- Release steps only on push to main ---
      - name: Create annotated git tag locally (for Release)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG}" -m "Automated release ${TAG}" || true
          git push origin "${TAG}" || true

      - name: Create GitHub Release + upload APK assets
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          body: |
            Automated release from CI for commit ${{ github.sha }}
            variant:${{ env.BUILD_VARIANT }}
            sha256:${{ env.APK_SHA256 }}
          files: |
            ${{ env.APK_PATH }}
            ${{ env.SHA_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to ThingsBoard and get JWT
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: tb_login
        shell: bash
        run: |
          set -euo pipefail
          TBHOST="${TB_HOST:-https://thingsboard.cloud}"
          TBHOST="${TBHOST%/}"

          echo "Logging into ThingsBoard at ${TBHOST}"
          LOGIN_RESP="$(curl -sS -X POST "${TBHOST}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${TB_USER}\",\"password\":\"${TB_PASS}\"}")"

          TB_TOKEN="$(echo "${LOGIN_RESP}" | jq -r '.token // .accessToken // empty')"
          if [[ -z "${TB_TOKEN}" ]]; then
            echo "ERROR: ThingsBoard login failed. Response:"
            echo "${LOGIN_RESP}"
            exit 1
          fi

          echo "TB_TOKEN=${TB_TOKEN}" >> "${GITHUB_ENV}"
          echo "Logged into ThingsBoard."

      - name: Upload APK into ThingsBoard OTA Updates (create package + upload binary)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          TBHOST="${TB_HOST:-https://thingsboard.cloud}"
          TBHOST="${TBHOST%/}"

          DEVICE_ID="${TARGET_DEVICE_ID:?TARGET_DEVICE_ID missing}"
          TITLE="${TB_OTA_TITLE:-BusFlow-Android}"
          TYPE="${TB_OTA_TYPE:-SOFTWARE}"
          VERSION="${TAG}"

          APK_PATH="${APK_PATH:?APK_PATH missing}"
          APK_SHA256="${APK_SHA256:?APK_SHA256 missing}"
          TB_TOKEN="${TB_TOKEN:?TB_TOKEN missing}"

          if [[ ! -f "${APK_PATH}" ]]; then
            echo "ERROR: APK file not found: ${APK_PATH}"
            exit 1
          fi

          # 1) Get deviceProfileId from the target device
          DEVICE_JSON="$(curl -sS -H "X-Authorization: Bearer ${TB_TOKEN}" \
            "${TBHOST}/api/device/${DEVICE_ID}")"

          DEVICE_PROFILE_ID="$(echo "${DEVICE_JSON}" | jq -r '.deviceProfileId.id // empty')"
          if [[ -z "${DEVICE_PROFILE_ID}" ]]; then
            echo "ERROR: Could not read deviceProfileId from device:"
            echo "${DEVICE_JSON}"
            exit 1
          fi

          # 2) Create OTA package info
          OTA_INFO="$(jq -n \
            --arg title "${TITLE}" \
            --arg version "${VERSION}" \
            --arg type "${TYPE}" \
            --arg dpId "${DEVICE_PROFILE_ID}" \
            '{title:$title, version:$version, type:$type,
              deviceProfileId:{entityType:"DEVICE_PROFILE", id:$dpId}}')"

          CREATE_RESP="$(curl -sS -w $'\n%{http_code}' -X POST "${TBHOST}/api/otaPackage" \
            -H "Content-Type: application/json" \
            -H "X-Authorization: Bearer ${TB_TOKEN}" \
            -d "${OTA_INFO}")"

          CREATE_JSON="$(echo "${CREATE_RESP}" | head -n -1)"
          CREATE_CODE="$(echo "${CREATE_RESP}" | tail -n 1)"

          OTA_ID=""
          if [[ "${CREATE_CODE}" == "200" || "${CREATE_CODE}" == "201" ]]; then
            OTA_ID="$(echo "${CREATE_JSON}" | jq -r '.id.id // empty')"
          else
            echo "Create OTA package returned HTTP ${CREATE_CODE}; trying to find existing package..."
            LIST_JSON="$(curl -sS -H "X-Authorization: Bearer ${TB_TOKEN}" \
              "${TBHOST}/api/otaPackages?pageSize=50&page=0&textSearch=${VERSION}")"
            OTA_ID="$(echo "${LIST_JSON}" | jq -r --arg t "${TITLE}" --arg v "${VERSION}" \
              '.data[] | select(.title==$t and .version==$v) | .id.id' | head -n 1)"
          fi

          if [[ -z "${OTA_ID}" ]]; then
            echo "ERROR: Could not determine OTA package id."
            echo "Create response:"
            echo "${CREATE_JSON}"
            exit 1
          fi

          # 3) Upload the APK binary to that OTA package
          curl -sS -X POST \
            "${TBHOST}/api/otaPackage/${OTA_ID}?checksumAlgorithm=SHA256&checksum=${APK_SHA256}" \
            -H "X-Authorization: Bearer ${TB_TOKEN}" \
            -F "file=@${APK_PATH};type=application/vnd.android.package-archive" \
            >/dev/null

          echo "✅ Uploaded to ThingsBoard OTA Updates: title=${TITLE}, version=${VERSION}, id=${OTA_ID}"

      - name: Cleanup local tag (optional)
        if: always()
        shell: bash
        run: |
          git tag -d "${{ env.TAG }}" || true
